events {
    worker_connections 1024;
}

http {
    upstream rag_service {
        server localhost:8001;
    }
    
    upstream memory_service {
        server localhost:8765;
    }
    
    upstream mcp_rag_service {
        server localhost:8002;
    }
    
    upstream mcp_memory_service {
        server localhost:8004;
    }
    
    upstream viz_service {
        server localhost:8003;
    }
    
    server {
        listen 80;
        server_name localhost;
        
        location /rag/ {
            proxy_pass http://rag_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        location /memory/ {
            proxy_pass http://memory_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        location /mcp-rag/ {
            proxy_pass http://mcp_rag_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location /mcp-memory/ {
            proxy_pass http://mcp_memory_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location /viz/ {
            proxy_pass http://viz_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location /health {
            return 200 'AI Knowledge Management System Status\nServices: /rag/, /memory/, /mcp-rag/, /mcp-memory/, /viz/\nDirect access: :8001, :8765, :8002, :8004, :8003';
            add_header Content-Type text/plain;
        }
        
        location / {
            return 200 '=== AI知识管理系统 ===\n\n可用服务:\n- RAG服务: http://localhost/rag/ 或 :8001\n- Memory服务: http://localhost/memory/ 或 :8765\n- MCP RAG: http://localhost/mcp-rag/ 或 :8002\n- MCP Memory: http://localhost/mcp-memory/ 或 :8004\n- 可视化: http://localhost/viz/ 或 :8003\n\n系统状态: http://localhost/health';
            add_header Content-Type text/plain;
        }
    }
}
